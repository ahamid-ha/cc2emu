#include "video.h"

const unsigned char epd_bitmap_mc6847charset [] = {
	0x0e, 0x11, 0x10, 0x16, 0x15, 0x15, 0x0e, 0x04, 0x0a, 0x11, 0x11, 0x1f, 0x11, 0x11, 0x0f, 0x12, 
	0x12, 0x0e, 0x12, 0x12, 0x0f, 0x0e, 0x11, 0x01, 0x01, 0x01, 0x11, 0x0e, 0x0f, 0x12, 0x12, 0x12, 
	0x12, 0x12, 0x0f, 0x1f, 0x01, 0x01, 0x0f, 0x01, 0x01, 0x1f, 0x1f, 0x01, 0x01, 0x0f, 0x01, 0x01, 
	0x01, 0x1e, 0x01, 0x01, 0x19, 0x11, 0x11, 0x1e, 0x11, 0x11, 0x11, 0x1f, 0x11, 0x11, 0x11, 0x0e, 
	0x04, 0x04, 0x04, 0x04, 0x04, 0x0e, 0x10, 0x10, 0x10, 0x10, 0x11, 0x11, 0x0e, 0x11, 0x09, 0x05, 
	0x03, 0x05, 0x09, 0x11, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x1f, 0x11, 0x1b, 0x15, 0x15, 0x11, 
	0x11, 0x11, 0x11, 0x13, 0x15, 0x19, 0x11, 0x11, 0x11, 0x1f, 0x11, 0x11, 0x11, 0x11, 0x11, 0x1f, 
	0x0f, 0x11, 0x11, 0x0f, 0x01, 0x01, 0x01, 0x0e, 0x11, 0x11, 0x11, 0x15, 0x09, 0x16, 0x0f, 0x11, 
	0x11, 0x0f, 0x05, 0x09, 0x11, 0x0e, 0x11, 0x02, 0x04, 0x08, 0x11, 0x0e, 0x1f, 0x04, 0x04, 0x04, 
	0x04, 0x04, 0x04, 0x11, 0x11, 0x11, 0x11, 0x11, 0x11, 0x0e, 0x11, 0x11, 0x11, 0x0a, 0x0a, 0x04, 
	0x04, 0x11, 0x11, 0x11, 0x15, 0x15, 0x1b, 0x11, 0x11, 0x11, 0x0a, 0x04, 0x0a, 0x11, 0x11, 0x11, 
	0x11, 0x0a, 0x04, 0x04, 0x04, 0x04, 0x1f, 0x10, 0x08, 0x04, 0x02, 0x01, 0x1f, 0x07, 0x01, 0x01, 
	0x01, 0x01, 0x01, 0x07, 0x01, 0x01, 0x02, 0x04, 0x08, 0x10, 0x10, 0x1c, 0x10, 0x10, 0x10, 0x10, 
	0x10, 0x1c, 0x04, 0x0e, 0x15, 0x04, 0x04, 0x04, 0x04, 0x00, 0x04, 0x02, 0x1f, 0x02, 0x04, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x04, 0x04, 0x04, 0x04, 0x00, 0x04, 0x0a, 0x0a, 
	0x0a, 0x00, 0x00, 0x00, 0x00, 0x0a, 0x0a, 0x1b, 0x00, 0x1b, 0x0a, 0x0a, 0x04, 0x1e, 0x01, 0x0e, 
	0x10, 0x0f, 0x04, 0x13, 0x13, 0x08, 0x04, 0x02, 0x19, 0x19, 0x02, 0x05, 0x05, 0x02, 0x15, 0x09, 
	0x16, 0x06, 0x06, 0x06, 0x00, 0x00, 0x00, 0x00, 0x04, 0x02, 0x01, 0x01, 0x01, 0x02, 0x04, 0x04, 
	0x08, 0x10, 0x10, 0x10, 0x08, 0x04, 0x00, 0x04, 0x0e, 0x1f, 0x0e, 0x04, 0x00, 0x00, 0x04, 0x04, 
	0x1f, 0x04, 0x04, 0x00, 0x00, 0x00, 0x00, 0x03, 0x03, 0x02, 0x01, 0x00, 0x00, 0x00, 0x1f, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x03, 0x10, 0x10, 0x08, 0x04, 0x02, 0x01, 0x01, 
	0x06, 0x09, 0x09, 0x09, 0x09, 0x09, 0x06, 0x04, 0x06, 0x04, 0x04, 0x04, 0x04, 0x0e, 0x0e, 0x11, 
	0x10, 0x0e, 0x01, 0x01, 0x1f, 0x0e, 0x11, 0x10, 0x0c, 0x10, 0x11, 0x0e, 0x08, 0x0c, 0x0a, 0x1f, 
	0x08, 0x08, 0x08, 0x1f, 0x01, 0x0f, 0x10, 0x10, 0x11, 0x0e, 0x0e, 0x01, 0x01, 0x0f, 0x11, 0x11, 
	0x0e, 0x1f, 0x10, 0x08, 0x04, 0x02, 0x01, 0x01, 0x0e, 0x11, 0x11, 0x0e, 0x11, 0x11, 0x0e, 0x0e, 
	0x11, 0x11, 0x1e, 0x10, 0x10, 0x0e, 0x00, 0x06, 0x06, 0x00, 0x06, 0x06, 0x00, 0x06, 0x06, 0x00, 
	0x06, 0x06, 0x04, 0x02, 0x08, 0x04, 0x02, 0x01, 0x02, 0x04, 0x08, 0x00, 0x00, 0x1f, 0x00, 0x1f, 
	0x00, 0x00, 0x02, 0x04, 0x08, 0x10, 0x08, 0x04, 0x02, 0x06, 0x09, 0x08, 0x04, 0x04, 0x00, 0x04
};

void render_text(uint8_t *memory, SDL_Renderer* renderer) {
    int start_x = 20;
    int start_y = 20;
    SDL_Rect rect;

    SDL_SetRenderDrawColor(renderer, 0, 200, 0, 255);
    rect.x = start_x;
    rect.y = start_y;
    rect.w = 256 * 4;
    rect.h = 128 * 4;
    SDL_RenderFillRect(renderer, &rect);

    for (int line=0; line < 16; line++) {
        for (int col=0; col < 32; col++) {
            uint16_t data = memory[1024 + (line * 32) + col];

            if (data < 128) {
                uint8_t inverted = 0xff;
                if (data >= 64) {
                    inverted = 0;
                }
                data = data & 63;
                SDL_SetRenderDrawColor(renderer, 0, 0, 0, 255);
                for (int row = 0; row < 8; row++) {
                    uint8_t mask = 0;
                    if (row < 7) mask = epd_bitmap_mc6847charset[data * 7 + row] << 1;
                    mask = mask ^ inverted;
                    for (int bit = 0; bit < 8; bit++) {
                        if ( (1 << bit) & mask) {
                            rect.x = start_x + (col * 8 + bit) * 4;
                            rect.y = start_y + (line * 8 + row) * 4;
                            rect.w = 4;
                            rect.h = 4;
                            SDL_RenderFillRect(renderer, &rect);
                        }
                    }
                }


            } else {
                rect.w = 4*8;
                rect.h = 4*8;
                rect.x = start_x + (col * 8) * 4;
                rect.y = start_y + (line * 8) * 4;
                SDL_SetRenderDrawColor(renderer, 0, 0, 0, 255);
                SDL_RenderFillRect(renderer, &rect);
                uint8_t color = (data >> 4) & 0b111;
                switch (color)
                {
                    case 0: SDL_SetRenderDrawColor(renderer, 0, 200, 0, 255); break;  // green
                    case 1: SDL_SetRenderDrawColor(renderer, 255, 255, 0, 255); break;  // yellow
                    case 2: SDL_SetRenderDrawColor(renderer, 0, 0, 200, 255); break;  // blue
                    case 3: SDL_SetRenderDrawColor(renderer, 200, 0, 0, 255); break;  // red
                    case 4: SDL_SetRenderDrawColor(renderer, 218, 160, 109, 255); break;  // buff
                    case 5: SDL_SetRenderDrawColor(renderer, 0, 200, 200, 255); break;  // cyan
                    case 6: SDL_SetRenderDrawColor(renderer, 200, 0, 200, 255); break;  // magenta
                    case 7: SDL_SetRenderDrawColor(renderer, 255, 165, 0, 255); break;  // orange
                }
                rect.w = 4*4;
                rect.h = 4*4;
                if (data & 0b1000) {
                    rect.x = start_x + (col * 8) * 4;
                    rect.y = start_y + (line * 8) * 4;
                    SDL_RenderFillRect(renderer, &rect);
                }
                if (data & 0b0100) {
                    rect.x = start_x + (col * 8 + 4) * 4;
                    rect.y = start_y + (line * 8) * 4;
                    SDL_RenderFillRect(renderer, &rect);
                }
                if (data & 0b0010) {
                    rect.x = start_x + (col * 8) * 4;
                    rect.y = start_y + (line * 8 + 4) * 4;
                    SDL_RenderFillRect(renderer, &rect);
                }
                if (data & 0b0001) {
                    rect.x = start_x + (col * 8 + 4) * 4;
                    rect.y = start_y + (line * 8 + 4) * 4;
                    SDL_RenderFillRect(renderer, &rect);
                }
            }
        }
    }
}
